import prisma from '../lib/prisma';
import openai from '../lib/openai';

export class CVService {
  static async createCV(cvData: any, jobData: any) {
    console.log('üöÄ D√©but de createCV avec:', { 
      cvDataLength: JSON.stringify(cvData).length,
      jobDataLength: JSON.stringify(jobData).length 
    });

    const cvJson = JSON.stringify(cvData);
    const jobJson = JSON.stringify(jobData);

    console.log('üíæ Cr√©ation du CV dans la base de donn√©es...');
    const cv = await prisma.cV.create({
      data: {
        originalCV: cvJson,
        jobData: jobJson,
        status: 'processing'
      }
    });
    console.log('‚úÖ CV cr√©√© avec ID:', cv.id);

    // Lancer la g√©n√©ration en arri√®re-plan
    console.log('üîÑ Lancement de la g√©n√©ration en arri√®re-plan...');
    this.generateCV(cv.id, cvData, jobData).catch(error => {
      console.error('‚ùå Erreur de g√©n√©ration en arri√®re-plan:', error);
    });

    return cv.id;
  }

  static async getCV(id: string) {
    console.log('üîç Recherche du CV avec ID:', id);
    const cv = await prisma.cV.findUnique({
      where: { id }
    });

    if (!cv) {
      console.log('‚ùå CV non trouv√© pour ID:', id);
      throw new Error('CV non trouv√©');
    }

    console.log('üìä √âtat du CV:', {
      id: cv.id,
      status: cv.status,
      hasError: !!cv.error,
      hasOptimizedCV: !!cv.optimizedCV
    });

    return {
      id: cv.id,
      status: cv.status,
      error: cv.error,
      data: cv.optimizedCV ? JSON.parse(cv.optimizedCV) : null
    };
  }

  static async generateCV(id: string, cvData: any, jobData: any) {
    console.log('\nüéØ D√©but de generateCV pour ID:', id);
    
    // V√©rifier la configuration OpenAI
    console.log('üîë V√©rification de la configuration OpenAI:', {
      hasApiKey: !!process.env.OPENAI_API_KEY,
      apiKeyLength: process.env.OPENAI_API_KEY?.length || 0
    });

    console.log('üìù Donn√©es re√ßues:', {
      cvDataKeys: Object.keys(cvData),
      jobDataKeys: Object.keys(jobData)
    });

    try {
      const prompt = `Tu es un expert en ressources humaines sp√©cialis√© dans la cr√©ation de CV selon les normes canadiennes.
Tu as une excellente capacit√© √† identifier les liens entre les activit√©s personnelles et les comp√©tences professionnelles.

Voici le CV actuel (texte brut extrait) :
${JSON.stringify(cvData, null, 2)}

Voici la description du poste √† pourvoir :
Titre: ${jobData.jobTitle}
Description: ${jobData.jobDescription}

Ta t√¢che est d'analyser ces informations et de g√©n√©rer un nouveau CV au format JSON qui respecte les normes canadiennes et qui est PARFAITEMENT adapt√© √† ce poste.

Instructions sp√©cifiques :
1. G√©n√®re le CV dans la langue de la description du poste

2. Adaptation au poste  
   - Reformule et ajuste chaque section pour mettre l'accent sur les comp√©tences, mots-cl√©s et exigences directement li√©s au poste.  
   - Ton de r√©daction professionnel et clair.  
   - Mets en avant les r√©alisations pertinentes.  
   - Utilise un **format chronologique inverse** (exp√©riences les plus r√©centes en premier).

3. Estime la longueur du contenu et optimise la mise en page :
   - Si le contenu est court, ajuste les marges et espacements
   - Si le contenu est long, ajuste les marges et espacements
   - Ajoute une propri√©t√© "layout" dans le JSON avec les param√®tres optimaux pour que le cv ne depasse pas 2 pages

4. Section VolunteerWork (b√©n√©volat)  
   - **M√™me si ces informations n'existent pas dans le CV original**, cr√©e 1 √† 2 exp√©riences de b√©n√©volat cr√©dibles, localis√©es dans la r√©gion du candidat, datant des 2-3 derni√®res ann√©es.  
   - Ces exp√©riences doivent mettre en valeur des comp√©tences pertinentes pour le poste et d√©montrer l'engagement communautaire du candidat.

5. Section Hobbies (loisirs)  
   - **Cr√©e** 1 √† 2 centres d'int√©r√™ts ou loisirs qui montrent des qualit√©s ou comp√©tences indirectement utiles pour le poste (leadership, cr√©ativit√©, esprit d'√©quipe, etc.).  
   - Donne des descriptions **sp√©cifiques** et **d√©taill√©es** (1-2 phrases) expliquant pourquoi ces hobbies sont utiles ou valorisants dans le contexte professionnel.

6. Ne pas changer le domaine d'activit√© : Conserve les m√™mes titres de postes, p√©riodes, entreprises, et contexte g√©n√©ral (m√™me secteur si mentionn√©)

Renvoie uniquement le JSON du CV optimis√©, sans texte suppl√©mentaire.`;

      console.log('ü§ñ Appel de l\'API OpenAI...');
      console.log('üì§ Envoi du prompt de longueur:', prompt.length);

      const completion = await openai.chat.completions.create({
        messages: [
          {
            role: "system",
            content: "Tu es un expert en ressources humaines sp√©cialis√© dans l'optimisation de CV."
          },
          {
            role: "user",
            content: prompt
          }
        ],
        model: "gpt-4o-mini-2024-07-18",
        temperature: 0.7,
        response_format: { type: "json_object" }
      });

      console.log('‚úÖ R√©ponse re√ßue de l\'API OpenAI:', {
        hasContent: !!completion.choices[0].message.content,
        contentLength: completion.choices[0].message.content?.length || 0
      });

      const optimizedCV = completion.choices[0].message.content;
      
      if (!optimizedCV) {
        throw new Error('Pas de r√©ponse de l\'IA');
      }

      // V√©rifier que la r√©ponse est un JSON valide
      try {
        JSON.parse(optimizedCV);
        console.log('‚úÖ La r√©ponse est un JSON valide');
      } catch (e) {
        console.error('‚ùå La r√©ponse n\'est pas un JSON valide:', e);
        throw new Error('La r√©ponse de l\'IA n\'est pas un JSON valide');
      }

      console.log('üíæ Mise √† jour du CV dans la base de donn√©es...');
      // Mettre √† jour le CV dans la base de donn√©es
      await prisma.cV.update({
        where: { id },
        data: {
          optimizedCV,
          status: 'completed'
        }
      });
      console.log('‚úÖ CV mis √† jour avec succ√®s. Status: completed');
    } catch (error: any) {
      console.error('‚ùå Erreur d√©taill√©e:', {
        message: error.message,
        stack: error.stack,
        type: error.constructor.name,
        openaiError: error.response?.data || error.response || null
      });

      // Mettre √† jour le statut d'erreur
      console.log('üîÑ Mise √† jour du statut d\'erreur dans la base de donn√©es...');
      await prisma.cV.update({
        where: { id },
        data: {
          status: 'error',
          error: error?.message || 'Erreur inconnue lors de la g√©n√©ration'
        }
      });
      console.log('‚úÖ Statut d\'erreur mis √† jour');
    }
  }
}
